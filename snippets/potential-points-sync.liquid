{% comment %}
  Syncs potential loyalty points FROM section app block (order-placed-potential-points-amount)
  INTO main-product app block. Uses section value as source of truth (e.g. after country change).
  LOCAL CHECK: Inspect the #loy-potential-points inside the product info (price area) â€”
  class "loyalty-points-synced" = script ran; data-potential-points-value = number used.
{% endcomment %}
<script>
  (function() {
    function parsePointsNumber(str) {
      if (!str || typeof str !== 'string') return null;
      var trimmed = str.trim().replace(/,/g, '');
      return trimmed && !isNaN(parseInt(trimmed, 10)) ? trimmed : null;
    }

    function getPotentialPointsValue() {
      var mainProduct = document.querySelector('[id^="MainProduct-"]');
      var value = null;
      var fromSection = null;

      var spanSelectors = 'span.order-placed-potential-points-amount, span.cantidad-de-puntos-potenciales-pedidos';
      var allSpans = document.querySelectorAll(spanSelectors);
      for (var i = 0; i < allSpans.length; i++) {
        var text = parsePointsNumber(allSpans[i].textContent);
        if (text) {
          if (mainProduct && !mainProduct.contains(allSpans[i])) {
            fromSection = text;
            break;
          }
          if (!value) value = text;
        }
      }
      if (fromSection !== null) return fromSection;
      if (value) return value;

      var sections = document.querySelectorAll('[id^="shopify-section-"]');
      for (var s = 0; s < sections.length; s++) {
        if (sections[s].querySelector('[id^="MainProduct-"]')) continue;
        var block = sections[s].querySelector('#loy-potential-points, #potential-points-text, #puntos-potenciales-de-lealtad, #puntos-potenciales-texto');
        if (block) {
          var sectionText = block.textContent || '';
          var match = sectionText.match(/\b(\d{1,6}(?:,\d{3})*)\b/);
          if (match) {
            var parsed = parsePointsNumber(match[1]);
            if (parsed) return parsed;
          }
        }
      }
      return null;
    }

    function replacePotentialPointsInProductInfo() {
      var pointsValue = getPotentialPointsValue();
      var productInfo = document.querySelector('[id^="ProductInfo-"]');
      if (!productInfo) return false;
      var container = productInfo.querySelector('#loy-potential-points') || productInfo.querySelector('#puntos-potenciales-de-lealtad') || productInfo.querySelector('#potential-points-text') || productInfo.querySelector('#puntos-potenciales-texto');
      if (!container) return false;

      if (!pointsValue) {
        container.classList.remove('loyalty-points-synced');
        container.removeAttribute('data-potential-points-value');
        container.classList.add('loyalty-points-not-synced');
        return false;
      }

      var didSomething = false;

      function hasPlaceholder(str) {
        return str.indexOf('[potential_points]') !== -1 || str.indexOf('[puntos_potenciales]') !== -1 || str.indexOf('[points_potentiels]') !== -1;
      }
      function replacePlaceholders(str) {
        return str.replace(/\[potential_points\]/g, pointsValue).replace(/\[puntos_potenciales\]/g, pointsValue).replace(/\[points_potentiels\]/g, pointsValue);
      }
      function walkReplaceText(node) {
        if (node.nodeType === Node.TEXT_NODE) {
          if (hasPlaceholder(node.textContent)) {
            node.textContent = replacePlaceholders(node.textContent);
            return true;
          }
        } else if (node.nodeType === Node.ELEMENT_NODE) {
          var isPointsSpan = node.classList && (node.classList.contains('order-placed-potential-points-amount') || node.classList.contains('cantidad-de-puntos-potenciales-pedidos'));
          if (isPointsSpan) {
            var current = (node.textContent || '').trim();
            if (current !== pointsValue && (current === '' || current === '[potential_points]' || current === '[puntos_potenciales]' || current === '[points_potentiels]' || !isNaN(parseInt(current, 10)))) {
              node.textContent = pointsValue;
              didSomething = true;
            }
            return false;
          }
          if (node.childNodes) {
            for (var j = 0; j < node.childNodes.length; j++) {
              if (walkReplaceText(node.childNodes[j])) didSomething = true;
            }
          }
        }
        return false;
      }
      walkReplaceText(container);

      container.classList.add('loyalty-points-synced');
      container.classList.remove('loyalty-points-not-synced');
      container.setAttribute('data-potential-points-value', pointsValue);
      return true;
    }

    function syncPotentialPoints() {
      replacePotentialPointsInProductInfo();
    }

    function run() {
      syncPotentialPoints();
      setTimeout(syncPotentialPoints, 800);
      setTimeout(syncPotentialPoints, 2000);
      setTimeout(syncPotentialPoints, 4000);
      setTimeout(syncPotentialPoints, 6000);
      setTimeout(syncPotentialPoints, 8000);
      setTimeout(syncPotentialPoints, 12000);
      if (typeof MutationObserver !== 'undefined') {
        var syncTimer = null;
        var observer = new MutationObserver(function(mutations) {
          for (var m = 0; m < mutations.length; m++) {
            var mut = mutations[m];
            if (mut.addedNodes && mut.addedNodes.length) {
              if (!syncTimer) syncTimer = setTimeout(function() { syncTimer = null; syncPotentialPoints(); }, 500);
              break;
            }
            var isPointsSpan = mut.target.classList && (mut.target.classList.contains('order-placed-potential-points-amount') || mut.target.classList.contains('cantidad-de-puntos-potenciales-pedidos'));
            if (mut.type === 'characterData' || isPointsSpan) {
              if (!syncTimer) syncTimer = setTimeout(function() { syncTimer = null; syncPotentialPoints(); }, 500);
              break;
            }
          }
        });
        observer.observe(document.body, { childList: true, subtree: true, characterData: true, characterDataOldValue: true });
        setTimeout(function() { observer.disconnect(); }, 20000);
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', run);
    } else {
      run();
    }
  })();
</script>
<style>
div#loy-potential-points {
    border-radius: 20px;
    border: 1px solid #ebebeb;
    background: #fff;
    display: inline-flex !important;
    gap: 7px !important;
    align-items: center;
    height: 29px;
    padding: 0 10px 0 5px;
    color: #333;
    font-size: 16px;
    font-family: 'Prompt';
    font-weight: 400;
    justify-content: flex-start !important;
    padding: 0 7px !important;
    margin: 10px 0;
}

div#loy-potential-points div#potential-points-icon {
    margin: 0 !IMPORTANT;
    display: flex;
}

div#loy-potential-points div#potential-points-icon img.points-icon {
    width: 22px;
    height: 19px;
}

div#potential-points-text h3 {
    font-size: 16px;
    font-family: 'Prompt' !important;
    font-weight: 400 !important;
    margin: 0 !important;
    display: flex;
    gap: 3px;
    align-items: center;
    letter-spacing: -.16px;
}

div#potential-points-text h3 span.order-placed-potential-points-amount {
    display: flex;
    line-height: 16px;
}

div#potential-points-text {
    display: flex;
}
</style>
