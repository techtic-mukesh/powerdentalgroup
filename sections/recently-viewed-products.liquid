{{ 'component-card.css' | asset_url | stylesheet_tag }}
{{ 'component-price.css' | asset_url | stylesheet_tag }}
{{ 'section-related-products.css' | asset_url | stylesheet_tag }}

{% if section.settings.image_shape == 'blob' %}
  {{ 'mask-blobs.css' | asset_url | stylesheet_tag }}
{%- endif -%}

{%- unless section.settings.quick_add == 'none' -%}
  {{ 'quick-add.css' | asset_url | stylesheet_tag }}
{%- endunless -%}

{%- if section.settings.quick_add == 'standard' -%}
  <script src="{{ 'quick-add.js' | asset_url }}" defer="defer"></script>
  <script src="{{ 'product-form.js' | asset_url }}" defer="defer"></script>
{%- endif -%}

{%- if section.settings.quick_add == 'bulk' -%}
  <script src="{{ 'quick-add-bulk.js' | asset_url }}" defer="defer"></script>
  <script src="{{ 'quantity-popover.js' | asset_url }}" defer="defer"></script>
  <script src="{{ 'price-per-item.js' | asset_url }}" defer="defer"></script>
  <script src="{{ 'quick-order-list.js' | asset_url }}" defer="defer"></script>
{%- endif -%}

{%- style -%}
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
  }

  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }
{%- endstyle -%}

<div class="color-{{ section.settings.color_scheme }} gradient">
  <div 
    class="recently-viewed-products page-width section-{{ section.id }}-padding isolate{% if settings.animations_reveal_on_scroll %} scroll-trigger animate--slide-in{% endif %}"
    id="RecentlyViewed-{{ section.id }}"
  >
    <h2 class="recently-viewed-products__heading inline-richtext {{ section.settings.heading_size }}">
      {{ section.settings.heading }}
    </h2>
    
    <ul
      class="grid product-grid grid--{{ section.settings.columns_desktop }}-col-desktop grid--{{ section.settings.columns_mobile }}-col-tablet-down {% if section.settings.quick_add == 'bulk' %} collection-quick-add-bulk{% endif %}"
      role="list"
      id="RecentlyViewedGrid-{{ section.id }}"
    >
      <!-- Products injected via JS -->
    </ul>

    <div class="recently-viewed-error" id="RecentlyViewedError-{{ section.id }}">
      <p>{{ section.settings.error_message | default: 'Unable to load recently viewed products.' }}</p>
    </div>
  </div>

  {% if section.settings.image_shape == 'arch' %}
    {{ 'mask-arch.svg' | inline_asset_content }}
  {%- endif -%}
</div>

<script>
(function() {
  const SECTION_ID = '{{ section.id }}';
  const RECENTLY_VIEWED_KEY = 'recentlyViewedProducts';
  const MAX_PRODUCTS = {{ section.settings.products_to_show }};

  const grid = document.getElementById(`RecentlyViewedGrid-${SECTION_ID}`);
  const errorDiv = document.getElementById(`RecentlyViewedError-${SECTION_ID}`);

  // Get recently viewed from localStorage
  function getRecentlyViewed() {
    try {
      const viewed = JSON.parse(localStorage.getItem(RECENTLY_VIEWED_KEY)) || [];
      {% if product %}
        return viewed.filter(h => h !== '{{ product.handle }}');
      {% else %}
        return viewed;
      {% endif %}
    } catch(e) {
      return [];
    }
  }

  // Save current product
  {% if product %}
    const currentHandle = '{{ product.handle }}';
    let rv = getRecentlyViewed();
    rv = [currentHandle, ...rv.filter(h => h !== currentHandle)].slice(0, MAX_PRODUCTS*2);
    localStorage.setItem(RECENTLY_VIEWED_KEY, JSON.stringify(rv));
  {% endif %}

  // Build Dawn card HTML
  function createCardHTML(product) {
    const li = document.createElement('li');
    li.className = 'grid__item';
    li.innerHTML = `
      <div class="card-wrapper product-card-wrapper underline-links-hover">
        <div class="card card--standard card--media" style="--ratio-percent: 100%;">
          <div class="card__inner color-scheme-2 gradient ratio" style="--ratio-percent: 100%;">
            <div class="card__media">
              <div class="media media--transparent media--hover-effect">
                <img src="${product.featured_image}" alt="${product.title}" class="motion-reduce" loading="lazy" width="700" height="700">
              </div>
            </div>
            <div class="card__content">
              <div class="card__information">
                <h3 class="card__heading">
                  <a href="${product.url}" class="full-unstyled-link">${product.title}</a>
                </h3>
                <div class="caption-large light">${product.vendor}</div>
                <div class="price">
                  <div class="price__container">
                    <div class="price__regular">
                      <span class="price-item price-item--regular">${product.price}</span>
                    </div>
                  </div>
                </div>
              </div>

              <div class="quick-add">
                <form method="post" action="/cart/add">
                  <input type="hidden" name="id" value="${product.variants[0].id}">
                  <button type="submit" class="quick-add__submit button button--full-width button--secondary">
                    <span>Add to cart</span>
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
    return li;
  }

  async function loadProducts() {
    const handles = getRecentlyViewed().slice(0, MAX_PRODUCTS);
    if (!handles.length) return;

    for (const handle of handles) {
      try {
        const res = await fetch(`/products/${handle}.js`);
        if (!res.ok) continue;
        const product = await res.json();

        const card = createCardHTML({
          title: product.title,
          url: `/products/${product.handle}`,
          featured_image: product.images[0] || '',
          vendor: product.vendor,
          price: `$${(product.price / 100).toFixed(2)}`,
          variants: product.variants
        });

        grid.appendChild(card);
      } catch(err) {
        console.warn(`Failed to load product ${handle}`, err);
      }
    }
  }

  document.addEventListener('DOMContentLoaded', loadProducts);
})();
</script>

{% schema %}
{
  "name": "Recently viewed products",
  "tag": "section",
  "class": "section",
  "settings": [
    { "type": "inline_richtext", "id": "heading", "default": "Recently viewed products", "label": "Heading" },
    { "type": "select", "id": "heading_size", "default": "h2", "label": "Heading size", "options":[
      { "value":"h1","label":"H1" },
      { "value":"h2","label":"H2" },
      { "value":"h0","label":"H0" },
      { "value":"hxl","label":"Extra large" },
      { "value":"hxxl","label":"Extra extra large" }
    ]},
    { "type": "range","id":"products_to_show","min":2,"max":10,"step":1,"default":4,"label":"Products to show"},
    { "type": "range","id":"columns_desktop","min":1,"max":6,"step":1,"default":4,"label":"Columns (desktop)"},
    { "type": "select","id":"columns_mobile","default":"2","label":"Columns (mobile)","options":[
      { "value":"1","label":"1 column"},
      { "value":"2","label":"2 columns"}
    ]},
    { "type":"color_scheme","id":"color_scheme","label":"Color scheme","default":"scheme-1"},
    { "type":"select","id":"image_ratio","options":[
      {"value":"adapt","label":"Adapt to image"},
      {"value":"portrait","label":"Portrait"},
      {"value":"square","label":"Square"}
    ],"default":"adapt","label":"Image ratio"},
    { "type":"select","id":"image_shape","options":[
      {"value":"default","label":"Default"},
      {"value":"arch","label":"Arch"},
      {"value":"blob","label":"Blob"},
      {"value":"chevronleft","label":"Chevron left"},
      {"value":"chevronright","label":"Chevron right"},
      {"value":"diamond","label":"Diamond"},
      {"value":"parallelogram","label":"Parallelogram"},
      {"value":"round","label":"Round"}
    ],"default":"default","label":"Image shape"},
    { "type":"checkbox","id":"show_secondary_image","default":false,"label":"Show secondary image"},
    { "type":"checkbox","id":"show_vendor","default":false,"label":"Show vendor"},
    { "type":"checkbox","id":"show_rating","default":false,"label":"Show product rating"},
    { "type":"select","id":"quick_add","default":"none","label":"Quick add","options":[
      {"value":"none","label":"None"},
      {"value":"standard","label":"Standard"},
      {"value":"bulk","label":"Bulk"}
    ]},
    { "type":"text","id":"error_message","label":"Error message","default":"Unable to load recently viewed products."},
    { "type":"range","id":"padding_top","min":0,"max":100,"step":4,"unit":"px","label":"Padding top","default":36},
    { "type":"range","id":"padding_bottom","min":0,"max":100,"step":4,"unit":"px","label":"Padding bottom","default":36}
  ],
  "presets":[{"name":"Recently viewed products"}]
}
{% endschema %}
